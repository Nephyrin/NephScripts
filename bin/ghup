#!/bin/bash

# Update the git repo, syncing its map file with any local exports
# and fixing missing tags
set -e
cd "$MOZPATH/moz-git"

. "$(dirname "$0")"/lib/util.sh

eval args=("$(parse_args ghsync u "" "$@")")
[ ${#args[@]} -le 1 ] || die "Unexpected argument"
update="$(get_option u)"
[ -z "$update" ] || update="-u"
branch="${args[0]}"

if [ ! -z "$branch" ] && [ ! -d "../mozilla-$branch" ]; then
  die "Branch $branch not found"
fi

estat "Updating git"
git fetch bangles
estat "Updating git map"
(
    cd "$MOZPATH/hg-git-map"
    git pull --no-edit
)

if [ ! -z "$branch" ]; then
  estat "Syncing $branch"
  ghsync $update "$branch"
fi

missing="$((git tag >/dev/null ) 2>&1 | sed -r 's/error: (.*) does.*/\1/g;tx;d;:x')"
if [ ! -z "$missing" ]; then
    estat "Fixing missing tags"
    git fetch bangles $missing
fi
