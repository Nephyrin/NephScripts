#!/bin/bash

set -e

source ~/.bashrc
lowprio

cfg=$1
forceconfig=$2

if [ -z "$cfg" ] || [ ! -f "m-${cfg}.mzc" ]; then
  echo >&2 "No config for '$cfg'"
  exit 1
fi

export PYTHON=python2
export MOZCONFIG="$PWD/m-${cfg}.mzc"

MAKE="eval time ionice -c3 make -j10"

echo ":: Switching moz-build-tree to build/$cfg"
(
  cd moz-build-tree
  git checkout build/"$cfg"
  git reset --hard
  git clean -xfd
)



trap "cpufreq-selector -c all -g ondemand" EXIT
cpufreq-selector -c all -g performance

if [ ! -f "$cfg/Makefile" ] || [ ! -z "$forceconfig" ]; then
  echo ":: Reconfiguring build directory"
  # Remove objdir's config to force a reconfigure
  rm -rfv "$cfg"/config.*
  (
    cd moz-build-tree
    $MAKE -f client.mk configure
  )
fi


cd "$cfg"

# Work around bug 717947
for x in {js/src/,}config; do
  $MAKE -C $x DIRS+=mkdepend mkdepend/Makefile
done

$MAKE && echo ":: Make succeeded"
