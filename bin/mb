#!/bin/bash

set -e

source ~/.bashrc
lowprio

cfg=$1
forceconfig=$2

if [ -z "$cfg" ] || [ ! -f "m-${cfg}.mzc" ]; then
  echo >&2 "No config for '$cfg'"
  exit 1
fi

export PYTHON=python2
export MOZCONFIG="$PWD/m-${cfg}.mzc"

MAKE="eval time ionice -c3 make -j10"

trap "cpufreq-selector -c all -g ondemand" EXIT
cpufreq-selector -c all -g performance

if [ ! -f "$cfg/Makefile" ] || [ ! -z "$forceconfig" ]; then
  echo ":: Reconfiguring build"
  # Remove objdir's config to force a reconfigure
  rm -rfv "$cfg"/config.*
  (
    cd moz-build-tree
    $MAKE -f client.mk configure
  )
fi

# Work around bug 717947
(
  cd "$cfg"
  for x in {js/src/,}config; do
    $MAKE -C $x DIRS+=mkdepend mkdepend/Makefile
  done
)

cd moz-build-tree
$MAKE -f client.mk && echo ":: Make succeeded"
