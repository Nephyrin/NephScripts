#!/bin/bash

set -e

. "$(dirname "$0")"/lib/util.sh
. "$(dirname "$0")"/../bashrc

parse_args mnuke '' '' "$@"
[ $(num_args) -le 2 ] || die "Takes one or two arguments (moz config setup)"
if [[ $(num_args) -ge 1 ]]; then
  eval args=("$(get_args)")
  moz "${args[@]}"
fi

[ ! -z "$MOZOBJ" ] || die "No moz config"

ifnuke() {
  if [ -d "$1" ]; then
    estat "Nuking $1"
    if [ -L "$1" ]; then
      ifnuke "$(readlink -f "$1")"
    fi
    cmd rm -rf "$1"
  else
    estat "$1 Doesn't exist, skipping"
  fi
}

cd "$MOZPATH"
ifnuke "$MOZOBJ"
ifnuke "mb-staging"
if [ ! -z "$MOZBUILDTREE" ] && [ "$MOZBUILDTREE" != "$MOZTREE" ]; then
  ifnuke "$MOZBUILDTREE"
  if [ -d "$MOZTREE/.git" ]; then
    estat "Removing branch build/$MOZBUILDTREE"
    cmd cd "$MOZTREE"
    cmd git branch -D "build/$MOZBUILDTREE" || true
  fi
fi
