#!/bin/bash

set -e
# Sync an hg repo to its git mirror

. "$(dirname "$0")"/lib/util.sh

parse_args ghsync u "" "$@"

[[ $(num_args) -eq 1 ]] || die "Usage: $0 <branch>"

update="$(get_option u)"
repo="$(basename "$(get_arg 0)")"
repo="${repo#mozilla-}"

estat "Updating $repo"
cd "$MOZPATH"
if [ ! -d "mozilla-$repo/.hg" ]; then
  echo >&2 "mozilla-$repo" does not appear to be a hg repository
  exit 1
fi

cd "mozilla-$repo"
if [ ! -e .hg/git ] || [ ! -e .hg/git-mapfile ] || [ ! -e .hg/git-branch ]; then
    echo >&2 "This repo lacks the necessary .hg/git* files for syncing"
    exit 1
fi

oldrev="$(hg log -r tip --template={rev})"
hg pull
newrev="$(hg log -r tip --template={rev})"
newgit="$(h2g $newrev 2>/dev/null || true)"

branch="$(cat .hg/git-branch)"

if [ "$newrev" != "$oldrev" ]; then
    hg up -C
    rm -f .hg/bookmarks
    hg bookmark -v -r tip "$branch"
fi

if [ -z "$newgit" ]; then
    if [[ $update -eq 1 ]]; then
        estat "Git is not up to date, exporting"
        hg gexport -v
        cd "$MOZPATH/hg-git-map"
        git commit -a -m "Locally imported revisions" || true
    else
        ewarn "git is behind mercurial - specify -u to convert missing revisions locally"
    fi
elif [ "$(cat "$MOZPATH/moz-git/.git/HEAD")" = "ref: refs/heads/$repo" ]; then
    echo >&2 '!!'" $repo is currently checked out in the master git repo, not updating ref"
else
    estat "Updating $repo ref ($branch) to $newgit"
    target="$MOZPATH/moz-git/.git/refs/heads/$branch"
    mkdir -pv "$(dirname "$target")"
    echo "$newgit" > "$target"
fi
