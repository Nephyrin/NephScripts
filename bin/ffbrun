#!/bin/bash

# Run given firefox on profile "<dirname firefox>/profile"
# Used for build dirs

set -e

die() {
  echo >&2 "$*"
  exit 1
}

export XPCOM_MEM_LEAK_LOG=1
export NSPR_LOG_MODULES="objlc:5"

optspec="gd:a:rx"
parseopts () {
    while [ $# -gt 0 ]; do
        case "$1" in
            "-g")
                exargs="$exargs -g"
                ;;
            "-d")
                exargs="$exargs -d '$2'"
                shift
                ;;
            "-a")
                exargs="$exargs -a '$2'"
                shift
                ;;
            "-r")
                exargs="$exargs -a '-ex run'"
                ;;
            "-x")
                freshprofile=1
                ;;
            "--")
                shift
                args=("$@")
                return
                ;;
        esac
        shift
    done
}
args=()
i=0
eval parseopts $(getopt -n ffbrun -o "$optspec" -- "$@")

target="${args[0]}"
args="${args[@]:1:${#args[@]}}"

if [ ! -d "$target" ] || [ ! -x "$target/firefox" ] || [ ! -x "$target/run-mozilla.sh" ]; then
  die "\"$target\" doesn't appear to contain a firefox build :("
fi

cd "$target"
if [ $freshprofile ]; then
  rm -rf profile
fi

if [ ! -d "profile" ]; then
  echo ":: Making fresh profile"
  mkdir profile
fi

eval cleangtk ./run-mozilla.sh "$exargs" "$target/firefox" -no-remote -profile ./profile "${args[@]}"
