#!/bin/bash

# Run given firefox on profile "<dirname firefox>/profile"
# Used for build dirs

set -e

die() {
  echo >&2 "$*"
  exit 1
}

target="$1"; shift
if [ -z "$target" ]; then
  die "First argument must be a built firefox directory"
fi

args=()
i=0
while [ $# -gt 0 ]; do
  case "$1" in
    "-g")
      exargs='-g'
    ;;
    "-x")
      freshprofile=1
    ;;
    *)
      args[i++]="$1"
    ;;
  esac
  shift
done

if [ ! -d "$target" ] || [ ! -x "$target/firefox" ] || [ ! -x "$target/run-mozilla.sh" ]; then
  die "\"$target\" doesn't appear to contain a firefox build :("
fi

cd "$target"
if [ $freshprofile ]; then
  rm -rf profile
fi

if [ ! -d "profile" ]; then
  echo ":: Making fresh profile"
  mkdir profile
fi

cleangtk ./run-mozilla.sh $exargs "$target/firefox" -no-remote -profile ./profile "${args[@]}"
