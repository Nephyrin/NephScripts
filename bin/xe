#!/bin/bash

## xe: Do-what-I-mean command to asynchronously open the given file in a GUI emacs frame on the current session's
##     display, creating one if none are present.
##
##     Spawns the emacs daemon if it isn't running (which is why it's not just an emacsclient alias).

# Use paired `ec` command for connecting to emacs in terminal (e.g. as $EDITOR).  `xe` doesn't auto-fallback to terminal
# in non-GUI sessions because it is meant to be an asynchronous pass-to-editor-elsewhere entrypoint.

set -euo pipefail

. ~/bin/lib/util.sh

# With -e/--eval we pass elisp-to-evaluate to emacsclient, otherwise files.
parse_args 'xe' 'e' 'eval' "$@" || die "Usage: xe [--eval] [--] {file|elisp_to_eval}"

options=()
[[ -n "$(get_merged_option e eval)" ]] && options+=(-e)
args=()
eval args=\("$(get_args)"\)

# Sanity
emacsclient --version || die "emacsclient command non-functional"

if ! emacsclient --eval t &>/dev/null; then
  einfo "cannot talk to emacs, trying to spawn emacs and trying again"
  # Spawn emacs in the graphical session
  if ! systemctl --user show-environment | grep -qE '^(WAYLAND_)?DISPLAY='; then
    die "emacs isn't running, and no session with a display appears to exist to spawn it"
  fi
  # This will block until emacs forks into the background post-daemon-start.
  cmd systemctl --user reset-failed neph-emacs || true
  cmd systemd-run --user --unit=neph-emacs --property=Type=forking -- emacs --daemon || true
  if ! systemctl --user is-active neph-emacs >/dev/null; then
    eerr "failed to talk to emacs, spawning emacs also didn't work:"
    cmd systemctl --user status neph-emacs
    die ':('
  fi
fi

cmd emacsclient -n -r "${options[@]}" -- "${args[@]}"
