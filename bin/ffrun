#!/bin/bash

# Run given firefox on clean profile

set -e

. "$(dirname "$(readlink -f "$0")")"/lib/util.sh

parse_args ffrun '' '' "$@"

eval args=("$(get_args)")

if [[ ${#args[@]} -gt 0 ]]; then
  ff="${args[0]}"
  args=("${args[@]:1}")
  if [ ! "$ff" = "-" ] && [ ! -x "$ff" ]; then
    die "\"$ff\" is not an executable target :("
  fi
fi

if [ -z "$ff" ] || [ "$ff" = "-" ]; then
  ff="$(which firefox)"
  if [ -z "$ff" ]; then
    die "No firefox given and 'which firefox' returns naught :("
  fi
fi

prof="$(mktemp -d -t ffrun_profile.XXXXXXX)"
estat "Temp profile is $prof"

trap "cmd rm -r '$prof'" EXIT

while true; do
  cmd cleangtk "$ff" -no-remote -profile "$prof" "${args[@]}" || ret=$?
  if [[ $ret -ne 0 ]]; then
    ewarn "Non-zero return code $ret"
  fi
  estat "Exited. Press return to re-launch or ctrl-C to end"
  read
done
