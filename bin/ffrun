#!/bin/bash

# Run given firefox on clean profile

set -e

. "$(dirname "$(readlink -f "$0")")"/lib/util.sh

parse_args ffrun '' 'accel,omtc' "$@"

eval args=("$(get_args)")

if [[ ${#args[@]} -gt 0 ]]; then
  ff="${args[0]}"
  args=("${args[@]:1}")
  if [ ! "$ff" = "-" ] && [ ! -x "$ff" ]; then
    die "\"$ff\" is not an executable target :("
  fi
fi

if [ -z "$ff" ] || [ "$ff" = "-" ]; then
  ff="$(which firefox)"
  if [ -z "$ff" ]; then
    die "No firefox given and 'which firefox' returns naught :("
  fi
fi

#
# Prefs
#

prefs=()
if [[ $(get_option omtc) ]]; then
  estat "Enabling OMTC"
  export MOZ_USE_OMTC=1
  prefs[${#prefs[@]}]='user_pref("layers.offmainthreadcomposition.enabled", true);'
  prefs[${#prefs[@]}]='user_pref("layers.offmainthreadcomposition.animate-opacity", true);'
  prefs[${#prefs[@]}]='user_pref("layers.offmainthreadcomposition.animate-transform", true);'
  prefs[${#prefs[@]}]='user_pref("layers.offmainthreadcomposition.async-animations", true);'
fi

if [[ $(get_option accel) ]]; then
  estat "Enabling hardware acceleration"
  prefs[${#prefs[@]}]='user_pref("layers.acceleration.force-enabled", true);'
  prefs[${#prefs[@]}]='user_pref("layers.async-video.enabled", true);'
fi

prof="$(mktemp -d -t ffrun_profile.XXXXXXX)"
trap "cmd rm -r '$prof'" EXIT
estat "Temp profile is $prof"

for pref in "${prefs[@]}"; do
  echo "$pref" >> "$prof"/user.js
done

while true; do
  cmd cleangtk "$ff" -no-remote -profile "$prof" "${args[@]}" || ret=$?
  if [[ $ret -ne 0 ]]; then
    ewarn "Non-zero return code $ret"
  fi
  estat "Exited. Press return to re-launch or ctrl-C to end"
  read
done
